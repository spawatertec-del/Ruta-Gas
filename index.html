<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUTA WATERTEC SPA</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#0a3d62; color:white; padding:15px; text-align:center; }
nav { display:flex; background:#1e3799; }
nav button { flex:1; padding:12px; border:none; background:#1e3799; color:white; cursor:pointer; }
nav button:hover { background:#4a69bd; }

section { display:none; padding:15px; }
section.active { display:block; }

input, select { padding:6px; margin-bottom:6px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
input::placeholder { color:#999; font-style:italic; }

button { padding:6px 10px; margin:2px 0; border:none; cursor:pointer; border-radius:4px; }
.guardar { background:#27ae60; color:white; width:100%; }

table { width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed; word-wrap:break-word; }
th, td { border:1px solid #ccc; padding:4px; text-align:center; }
th { background:#dcdde1; }

#registro div { max-width:500px; margin:auto; display:grid; grid-template-columns: 1fr; gap:6px; }

#filtroFecha, #busquedaDireccion { width:150px; display:inline-block; margin-right:6px; }
#busquedaDireccion::placeholder { color:#999; font-style:italic; }

.imprimir-btn { background:#2980b9; color:white; padding:6px 10px; border-radius:5px; cursor:pointer; display:inline-flex; align-items:center; gap:5px; margin-bottom:10px; }
.imprimir-btn:hover { background:#3498db; }

a { color:#2980b9; text-decoration:none; }
a:hover { text-decoration:underline; }

.editar { background:#f39c12; color:white; padding:4px 6px; margin-right:2px; }
.borrar { background:#c0392b; color:white; padding:4px 6px; }

.dashboard { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
.cuadro { background:white; border:1px solid #ccc; padding:10px; flex:1; min-width:150px; font-size:12px; }

.cuadro table{ width:100%; border-collapse:collapse; }
.cuadro th, .cuadro td { border:1px solid #ccc; padding:4px; text-align:center; font-size:12px; }
.cuadro th { background:#dcdde1; }
</style>
</head>
<body>

<header><h1>RUTA WATERTEC SPA</h1></header>
<nav>
  <button onclick="mostrar('registro')">Registrar Venta</button>
  <button onclick="mostrar('ventas')">Registro de Ventas</button>
</nav>

<!-- Registrar Venta -->
<section id="registro">
<h2>Registrar Venta</h2>
<div>
  <input type="date" id="fecha" placeholder="Fecha">
  <input type="text" id="direccion" placeholder="Direcci√≥n / Nombre">
  <input type="text" id="telefono" placeholder="Tel√©fono">
  <input type="number" id="costoU" placeholder="C. Unitario">
  <input type="number" id="cant" placeholder="Ud.">
  <select id="ep">
    <option value="" selected>E/P (Opcional)</option>
    <option value="Efectivo">Efectivo</option>
    <option value="Transferencia">Transferencia</option>
  </select>
  <select id="estado">
    <option value="" disabled selected>Estado</option>
    <option value="Pagado">Pagado</option>
    <option value="Pendiente">Pendiente</option>
  </select>
  <input type="text" id="observaciones" placeholder="Observaciones">
  <button class="guardar" onclick="guardarVenta()">Guardar</button>
</div>
</section>

<!-- Registro de Ventas -->
<section id="ventas" class="active">
<h2>Registro de Ventas</h2>

<div class="dashboard">
  <!-- Pendientes -->
  <div class="cuadro" id="cuadroPendientes"></div>
  <!-- Pagados -->
  <div class="cuadro" id="cuadroPagados"></div>
  <!-- Control de Caja -->
  <div class="cuadro" id="cuadroCaja"></div>
</div>

<input type="date" id="filtroFecha" onchange="mostrarVentas()">
<input type="text" id="busquedaDireccion" oninput="mostrarVentas()" placeholder="Direcci√≥n / Nombre...">
<button onclick="verTodas()">Ver todas</button>
<button onclick="filtrarPendientes()">Pendientes</button>
<button class="imprimir-btn" onclick="imprimirRuta()">üñ®Ô∏è Imprimir Ruta del D√≠a</button>

<div class="table-container">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Direcci√≥n / Nombre</th>
<th>Tel√©fono</th>
<th>C. Unitario</th>
<th>Ud.</th>
<th>Total</th>
<th>E/P</th>
<th>Estado</th>
<th>Observaciones</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaVentas"></tbody>
</table>
</div>
</section>

<script>
let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
let editIndex = -1;

function mostrar(id){
    document.querySelectorAll("section").forEach(s=>s.style.display="none"); 
    document.getElementById(id).style.display="block"; 
}

function formatearNumero(n){ return n.toLocaleString('es-CL',{minimumFractionDigits:0,maximumFractionDigits:0}); }

function guardarVenta(){
    const fecha = document.getElementById("fecha").value;
    const direccion = document.getElementById("direccion").value;
    const telefono = document.getElementById("telefono").value;
    const costoU = Number(document.getElementById("costoU").value);
    const cant = Number(document.getElementById("cant").value);
    const ep = document.getElementById("ep").value; 
    const estado = document.getElementById("estado").value;
    const observaciones = document.getElementById("observaciones").value;

    if(!fecha || !direccion || !telefono || !costoU || !cant || !estado){
        alert("Completa todos los campos (E/P es opcional)");
        return;
    }

    const total = costoU * cant;
    const venta = {fecha,direccion,telefono,costoU,cant,total,ep,estado,observaciones};

    if(editIndex>=0){ 
        ventas[editIndex]=venta; 
        editIndex=-1; 
    } else { 
        ventas.push(venta); 
    }
    localStorage.setItem("ventas",JSON.stringify(ventas));

    ["fecha","direccion","telefono","costoU","cant","observaciones"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("ep").value="";
    document.getElementById("estado").value="";

    mostrarVentas();
    mostrar('ventas');
}

function editarVenta(i){
    const v = ventas[i];
    document.getElementById("fecha").value = v.fecha;
    document.getElementById("direccion").value = v.direccion;
    document.getElementById("telefono").value = v.telefono;
    document.getElementById("costoU").value = v.costoU;
    document.getElementById("cant").value = v.cant;
    document.getElementById("ep").value = v.ep;
    document.getElementById("estado").value = v.estado;
    document.getElementById("observaciones").value = v.observaciones;
    editIndex = i;
    mostrar('registro');
}

function borrarVenta(i){
    if(confirm("¬øDeseas eliminar esta venta?")){
        ventas.splice(i,1);
        localStorage.setItem("ventas",JSON.stringify(ventas));
        mostrarVentas();
    }
}

function mostrarVentas(){
    const filtroFecha = document.getElementById("filtroFecha").value;
    const filtroDireccion = document.getElementById("busquedaDireccion").value.toLowerCase();
    const tabla = document.getElementById("tablaVentas");
    tabla.innerHTML="";

    let ventasFiltradas = ventas.filter(v =>
        (!filtroFecha || v.fecha === filtroFecha) &&
        (!filtroDireccion || v.direccion.toLowerCase().includes(filtroDireccion))
    );

    // Separar pendientes arriba
    const pendientes = ventasFiltradas.filter(v => v.estado === "Pendiente");
    const otros = ventasFiltradas.filter(v => v.estado !== "Pendiente");
    ventasFiltradas = [...pendientes, ...otros];

    ventasFiltradas.forEach((v,i)=>{
        const waMessage = `Hola,\n\nLe confirmamos que el d√≠a ${v.fecha} se entreg√≥ ${v.cant} recarga(s). Queda pendiente el pago correspondiente.\n\nMonto a pagar: $${formatearNumero(v.total)}\n\nAgradecemos su confirmaci√≥n.\n\nMuchas gracias.`;
        tabla.innerHTML += `<tr>
            <td>${v.fecha}</td>
            <td>${v.direccion}</td>
            <td><a href="https://wa.me/569${v.telefono}?text=${encodeURIComponent(waMessage)}" target="_blank">${v.telefono}</a></td>
            <td>$${formatearNumero(v.costoU)}</td>
            <td>${v.cant}</td>
            <td>$${formatearNumero(v.total)}</td>
            <td>${v.ep}</td>
            <td>${v.estado}</td>
            <td>${v.observaciones}</td>
            <td>
                <button class="editar" onclick="editarVenta(${i})">Editar</button>
                <button class="borrar" onclick="borrarVenta(${i})">Borrar</button>
            </td>
        </tr>`;
    });

    // Actualizar cuadros de resumen
    actualizarResumen(filtroFecha);
}

function verTodas(){ 
    document.getElementById("filtroFecha").value=""; 
    document.getElementById("busquedaDireccion").value=""; 
    mostrarVentas(); 
}

function filtrarPendientes(){
    const tabla = document.getElementById("tablaVentas");
    tabla.innerHTML="";
    const pendientes = ventas.filter(v => v.estado === "Pendiente");
    pendientes.forEach((v,i)=>{
        const waMessage = `Hola,\n\nLe confirmamos que el d√≠a ${v.fecha} se entreg√≥ ${v.cant} recarga(s). Queda pendiente el pago correspondiente.\n\nMonto a pagar: $${formatearNumero(v.total)}\n\nAgradecemos su confirmaci√≥n.\n\nMuchas gracias.`;
        tabla.innerHTML += `<tr>
            <td>${v.fecha}</td>
            <td>${v.direccion}</td>
            <td><a href="https://wa.me/569${v.telefono}?text=${encodeURIComponent(waMessage)}" target="_blank">${v.telefono}</a></td>
            <td>$${formatearNumero(v.costoU)}</td>
            <td>${v.cant}</td>
            <td>$${formatearNumero(v.total)}</td>
            <td>${v.ep}</td>
            <td>${v.estado}</td>
            <td>${v.observaciones}</td>
            <td>
                <button class="editar" onclick="editarVenta(${i})">Editar</button>
                <button class="borrar" onclick="borrarVenta(${i})">Borrar</button>
            </td>
        </tr>`;
    });
    actualizarResumen(document.getElementById("filtroFecha").value);
}

// Funci√≥n para actualizar los cuadros de Pendientes, Pagados y Control de Caja
function actualizarResumen(filtroFecha){
    let ventasFiltradas = ventas.filter(v => !filtroFecha || v.fecha === filtroFecha);

    // Pendientes
    let totalPendiente = 0;
    let pendientesHtml = '<strong>Pendientes</strong><table><tr><th>Mes</th><th>Pendiente</th></tr>';
    const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    meses.forEach((mes,idx)=>{
        const totalMes = ventasFiltradas.filter(v=> new Date(v.fecha).getMonth()===idx && v.estado==="Pendiente")
                        .reduce((sum,v)=>sum+v.total,0);
        pendientesHtml += `<tr><td>${mes}</td><td>$${formatearNumero(totalMes)}</td></tr>`;
        totalPendiente += totalMes;
    });
    pendientesHtml += `<tr><th>Total</th><th>$${formatearNumero(totalPendiente)}</th></tr></table>`;
    document.getElementById("cuadroPendientes").innerHTML = pendientesHtml;

    // Pagados
    let totalPagado = 0;
    let pagadosHtml = '<strong>Pagado</strong><table><tr><th>Mes</th><th>Pagado</th></tr>';
    meses.forEach((mes,idx)=>{
        const totalMes = ventasFiltradas.filter(v=> new Date(v.fecha).getMonth()===idx && v.estado==="Pagado")
                        .reduce((sum,v)=>sum+v.total,0);
        pagadosHtml += `<tr><td>${mes}</td><td>$${formatearNumero(totalMes)}</td></tr>`;
        totalPagado += totalMes;
    });
    pagadosHtml += `<tr><th>Total</th><th>$${formatearNumero(totalPagado)}</th></tr></table>`;
    document.getElementById("cuadroPagados").innerHTML = pagadosHtml;

    // Control de Caja
    let efectivo = ventasFiltradas.filter(v=>v.ep==="Efectivo").reduce((sum,v)=>sum+v.total,0);
    let transferencia = ventasFiltradas.filter(v=>v.ep==="Transferencia").reduce((sum,v)=>sum+v.total,0);
    let totalCaja = efectivo + transferencia;
    document.getElementById("cuadroCaja").innerHTML = `<strong>Control de Caja</strong><table>
    <tr><td>Efectivo</td><td>$${formatearNumero(efectivo)}</td></tr>
    <tr><td>Transferencia</td><td>$${formatearNumero(transferencia)}</td></tr>
    <tr><th>Total</th><th>$${formatearNumero(totalCaja)}</th></tr>
    </table>`;
}

function imprimirRuta(){
    const hoy = new Date().toISOString().slice(0,10);
    const ventasHoy = ventas.filter(v => v.fecha === hoy);

    let html = `<html>
    <head>
    <title>RUTA WATERTEC SPA</title>
    <style>
        body{font-family:Arial;margin:20px;} 
        h2, h3{text-align:center;margin:5px 0;}
        table{width:100%;border-collapse:collapse; margin-top:20px;}
        th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:14px;}
        th{background:#34495e;color:white;} 
        td{word-wrap:break-word;}
        td.observaciones{min-width:150px;}
        td.ep{min-width:100px;}
        tbody tr:nth-child(even){background:#f4f6f8;}
    </style>
    </head>
    <body>
        <h2>RUTA WATERTEC SPA</h2>
        <h3>DISTRIBUIDORA E IMPORTADORA</h3>
        <h3>WATERTEC SPA RUT: 77.198.537-8</h3>
        <h3>CHOFER: ____________________</h3>

        <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Direcci√≥n</th>
                <th>Tel√©fono</th>
                <th>C. Unitario</th>
                <th>Ud.</th>
                <th>Total</th>
                <th>E/P</th>
                <th>Observaciones</th>
            </tr>
        </thead>
        <tbody>`;

    ventasHoy.forEach(v=>{
        html += `<tr>
            <td>${v.fecha}</td>
            <td>${v.direccion}</td>
            <td>${v.telefono}</td>
            <td>$${formatearNumero(v.costoU)}</td>
            <td>${v.cant}</td>
            <td>$${formatearNumero(v.total)}</td>
            <td>${v.ep}</td>
            <td>${v.observaciones || ''}</td>
        </tr>`;
    });

    html += `</tbody></table></body></html>`;

    const ventana = window.open('', '_blank'); 
    ventana.document.write(html); 
    ventana.document.close(); 
    ventana.print();
}

mostrarVentas();
</script>

</body>
</html>


